function MersenneTwister(a){0==arguments.length&&(a=(new Date).getTime()),this._mt=new Array(624),this.setSeed(a)}tm.define("Application",{superClass:"tm.display.CanvasApp",init:function(){this.superInit("#main"),this.renderer=LayeredCanvasRenderer(this.canvas);var a=document.querySelector("#hmd");this.touch=tm.input.Touch(a,0),this.mouse=tm.input.Mouse(a),this.pointing=tm.isMobile?this.touch:this.mouse,a.addEventListener("touchstart",function(){this.pointing=this.touch}.bind(this)),a.addEventListener("mousedown",function(){this.pointing=this.mouse}.bind(this)),this.fps=60,this.background="transparent",this.resize(SCREEN_WIDTH,SCREEN_HEIGHT).fitWindow()}}),tm.define("LayeredCanvasRenderer",{superClass:"tm.display.CanvasRenderer",init:function(a){this.superInit(a)},renderObject:function(a){a instanceof CanvasLayer?a.render():tm.display.CanvasRenderer.prototype.renderObject.call(this,a)}}),tm.define("CanvasLayer",{superClass:"tm.display.CanvasElement",init:function(a){this.superInit(),this.setSize(SCREEN_WIDTH,SCREEN_HEIGHT),this.setOrigin(0,0),this.canvas=tm.graphics.Canvas(a),this.renderer=tm.display.CanvasRenderer(this.canvas),this.canvas.resize(SCREEN_WIDTH,SCREEN_HEIGHT).fitWindow(),this.renderInterval=2,this.isRenderFrame=!0},clear:function(){return this.canvas.clear(),this},update:function(a){this.isRenderFrame=a.frame%this.renderInterval===0},render:function(){this.isRenderFrame&&(this.canvas.clear(),this.renderer.render(this))}});var ASSETS={bullet:"assets/bullets.png","sound/bgm":"assets/nc91440.mp3","sound/miss":"assets/sei_ge_garasu_kudake02.mp3","sound/exp1":"assets/sei_ge_wareru01.mp3","sound/exp2":"assets/sei_ge_wareru02.mp3","sound/exp3":"assets/sei_ge_wareru03.mp3","sound/extend":"assets/extend.mp3","sound/score":"assets/sei_ge_coin_otosu02.mp3","sound/hit":"assets/sei_ge_garasu_hibi02.mp3","sound/ok":"assets/se_maoudamashii_system18.mp3","sound/cancel":"assets/se_maoudamashii_system45.mp3"},SCREEN_WIDTH=640,SCREEN_HEIGHT=960,W=SCREEN_WIDTH,H=1.2*W,PLAYER_SPEED=2.5,BIT_COUNT=4,BIT_DISTANCE=6,BIT_FIRST_DISTANCE=4,SHOT_SPEED=30,BULLET_POOL_SIZE=256,BULLET_BOUNDING_RADIUS=4,MT_SEED=54321,ENEMY_SMALL_HP=2,ENEMY_MIDDLE_HP=10,ENEMY_LARGE_HP=50,EXTEND_SCORE=1e5,Danmaku={};Danmaku.param=null,Danmaku.small=[],Danmaku.middle=[],Danmaku.large=[],function(){var a=bulletml.dsl.action,b=bulletml.dsl.actionRef,c=bulletml.dsl.bullet,d=(bulletml.dsl.bulletRef,bulletml.dsl.fire),e=(bulletml.dsl.fireRef,bulletml.dsl.changeDirection,bulletml.dsl.changeSpeed,bulletml.dsl.accel,bulletml.dsl.wait),f=bulletml.dsl.vanish,g=bulletml.dsl.repeat,h=(bulletml.dsl.bindVar,bulletml.dsl.notify,bulletml.dsl.direction),i=bulletml.dsl.speed,j=(bulletml.dsl.horizontal,bulletml.dsl.vertical,bulletml.dsl.fireOption,bulletml.dsl.offsetX,bulletml.dsl.offsetY,bulletml.dsl.autonomy,function(a){return c(a,{type:0})}),k=function(a){return c(a,{type:5})},l=function(a){return c(a,{type:6})},m=function(a){return c(a,{type:8})};Danmaku.small.push(new bulletml.Root({top:a([e(20),d(i(7),j)])})),Danmaku.small.push(new bulletml.Root({top:a([e(20),g(5,[d(i(7),j),e(20)])])})),Danmaku.small.push(new bulletml.Root({top:a([e(20),d(h(-30),i(7),j),d(h(0),i(7),j),d(h(30),i(7),j)])})),Danmaku.small.push(new bulletml.Root({top:a([e(20),g(10,[d(h(-30),i(7),j),d(h(0),i(7),j),d(h(30),i(7),j),e(20)])])})),Danmaku.small.push(new bulletml.Root({top:a([e(20),d(i(4),m),g(5,[d(h(-30),i(.4,"sequence"),j),d(h(0),i(0,"sequence"),j),d(h(30),i(0,"sequence"),j)])])})),Danmaku.small.push(new bulletml.Root({top:a([e(20),d(i(4),m),g(5,[d(h(-45),i(10),m(b("bit",45,"$loop.index"))),d(h(45),i(10),m(b("bit",-45,"$loop.index"))),d(h(0),i(10),m(b("bit",0,"$loop.index")))])]),bit:a([e(1),d(h("$1","relative"),i("10 + $2 * 0.2"),k),f()])})),Danmaku.small.push(new bulletml.Root({top:a([e(20),d(h(-4),i(6),k),g(4,[d(h(2,"sequence"),i(6),k)])])})),Danmaku.small.push(new bulletml.Root({top:a([e(20),g(5,[d(i(3),l),e(50)])])})),Danmaku.small.push(new bulletml.Root({top:a([e(20),d(i(6),m),g(5,[d(h(180,"absolute"),i(.2,"sequence"),k)])])}))}(),function(){var a=bulletml.dsl.action,b=bulletml.dsl.actionRef,c=bulletml.dsl.bullet,d=(bulletml.dsl.bulletRef,bulletml.dsl.fire),e=(bulletml.dsl.fireRef,bulletml.dsl.changeDirection,bulletml.dsl.changeSpeed,bulletml.dsl.accel,bulletml.dsl.wait),f=bulletml.dsl.vanish,g=bulletml.dsl.repeat,h=(bulletml.dsl.bindVar,bulletml.dsl.notify,bulletml.dsl.direction),i=bulletml.dsl.speed,j=(bulletml.dsl.horizontal,bulletml.dsl.vertical,bulletml.dsl.fireOption,bulletml.dsl.offsetX,bulletml.dsl.offsetY,bulletml.dsl.autonomy,function(a){return c(a,{type:1})}),k=function(a){return c(a,{type:4})},l=function(a){return c(a,{type:7})},m=function(a){return c(a,{type:8})};Danmaku.middle.push(new bulletml.Root({top1:a([g(999,[e(50),g(4,[d(h(270,"absolute"),i(30),m(b("bit"))),d(h(90,"absolute"),i(30),m(b("bit"))),e(5)])])]),bit:a([e(1),d(h(176,"absolute"),i(4),k),d(h(184,"absolute"),i(4),k),f()]),top2:a([g(999,[e(90),d(i(3),m),g(6,[d(h(0,"sequence"),i(.4,"sequence"),j)])])])})),Danmaku.middle.push(new bulletml.Root({top:a([e(100),g(999,[d(m),g(10,[d(h(0,"sequence"),i(12),l),e(3)]),e(100)])])})),Danmaku.middle=[Danmaku.middle.last]}(),function(){var a=bulletml.dsl.action,b=(bulletml.dsl.actionRef,bulletml.dsl.bullet),c=(bulletml.dsl.bulletRef,bulletml.dsl.fire),d=(bulletml.dsl.fireRef,bulletml.dsl.changeDirection,bulletml.dsl.changeSpeed,bulletml.dsl.accel,bulletml.dsl.wait),e=(bulletml.dsl.vanish,bulletml.dsl.repeat),f=(bulletml.dsl.bindVar,bulletml.dsl.notify,bulletml.dsl.direction,bulletml.dsl.speed),g=(bulletml.dsl.horizontal,bulletml.dsl.vertical,bulletml.dsl.fireOption,bulletml.dsl.offsetX,bulletml.dsl.offsetY,bulletml.dsl.autonomy,function(a){return b(a,{type:6})});Danmaku.large.push(new bulletml.Root({top:a([e(999,[d(20),c(f(5),g)])])}))}(),MersenneTwister._mulUint32=function(a,b){var c=a>>>16,d=65535&a,e=b>>>16,f=65535&b;return(c*f+d*e<<16)+d*f>>>0},MersenneTwister._toNumber=function(a){return"number"!=typeof a||isNaN(a)?0:Math.ceil(a)},MersenneTwister.prototype.setSeed=function(a){var b=this._mt;if("number"==typeof a){b[0]=a>>>0;for(var c=1;c<b.length;c++){var d=b[c-1]^b[c-1]>>>30;b[c]=MersenneTwister._mulUint32(1812433253,d)+c}this._index=b.length}else{if(!(a instanceof Array))throw new TypeError("MersenneTwister: illegal seed.");var c=1,e=0;this.setSeed(19650218);for(var f=Math.max(b.length,a.length);f>0;f--){var d=b[c-1]^b[c-1]>>>30;d=MersenneTwister._mulUint32(d,1664525),b[c]=(b[c]^d)+(a[e]>>>0)+e,++c>=b.length&&(b[0]=b[b.length-1],c=1),++e>=a.length&&(e=0)}for(var f=b.length-1;f>0;f--){var d=b[c-1]^b[c-1]>>>30;d=MersenneTwister._mulUint32(d,1566083941),b[c]=(b[c]^d)-c,++c>=b.length&&(b[0]=b[b.length-1],c=1)}b[0]=2147483648}},MersenneTwister.prototype._nextInt=function(){var a,b=this._mt;if(this._index>=b.length){var c=0,d=b.length,e=397;do a=2147483648&b[c]|2147483647&b[c+1],b[c]=b[c+e]^a>>>1^(1&a?2567483615:0);while(++c<d-e);do a=2147483648&b[c]|2147483647&b[c+1],b[c]=b[c+e-d]^a>>>1^(1&a?2567483615:0);while(++c<d-1);a=2147483648&b[d-1]|2147483647&b[0],b[d-1]=b[e-1]^a>>>1^(1&a?2567483615:0),this._index=0}return a=b[this._index++],a^=a>>>11,a^=a<<7&2636928640,a^=a<<15&4022730752,a^=a>>>18,a>>>0},MersenneTwister.prototype.nextInt=function(){var a,b;switch(arguments.length){case 0:return this._nextInt();case 1:a=0,b=MersenneTwister._toNumber(arguments[0]);break;default:a=MersenneTwister._toNumber(arguments[0]),b=MersenneTwister._toNumber(arguments[1])-a}if(!(b>0&&4294967296>b))return this._nextInt()+a;if((b&~b+1)==b)return(b-1&this._nextInt())+a;var c;do c=this._nextInt();while(b>4294967296-(c-(c%=b)));return c+a},MersenneTwister.prototype.next=function(){var a=this._nextInt()>>>5,b=this._nextInt()>>>6;return(67108864*a+b)/9007199254740992},tm.define("Background",{superClass:"tm.display.CanvasElement",init:function(){this.superInit(),this.fromJSON({children:{bg:{type:"tm.display.CanvasElement"},fg:{type:"tm.display.CanvasElement"}}}),this.clipping=!0,this.setSize(W,H),this.setOrigin(0,0),this.stars=Array.range(20).map(function(){var a=Math.rand(50,150),b=Math.rand(0,360),c=Math.rand(5,20),d=Math.randf(-5,5);return tm.display.PolygonShape({sides:Math.rand(3,9),width:a,height:a,fillStyle:"hsla({0}, 90%,  5%, 0.1)".format(b),strokeStyle:"hsla({0}, 90%, 80%, 0.1)".format(b)}).setBlendMode("lighter").setPosition(Math.rand(0,W),Math.rand(H*-.5,1.5*H)).on("enterframe",function(){this.rotation+=d,this.y+=c,this.y>1.5*H&&(this.x=Math.rand(0,W),this.y=H*-.5)}).addChildTo(this.bg)}.bind(this))},update:function(a){this.color=Math.floor(a.frame/30%360)},draw:function(a){a.setFillStyle(tm.graphics.RadialGradient(.5*W,.05*H,0,.5*W,.05*H,H).addColorStopList([{offset:0,color:"hsla({0}, 30%, 10%, 1.0)".format(this.color||0)},{offset:1,color:"hsla({0}, 30%, 10%, 1.0)".format((this.color||0)-30)}]).toStyle()).fillRect(0,0,W,H)}}),tm.define("Enemy",{superClass:"tm.display.RoundRectangleShape",init:function(a,b){this.superInit({width:a,height:a,strokeStyle:"hsl({0}, 45%, 40%)".format(b),fillStyle:"hsl({0}, 45%, 20%)".format(b),lineWidth:8}),this.boundingType="rect",this.checkHierarchy=!1,this.size=a,this.runner=null,this.hp=ENEMY_SMALL_HP,this.erasing=!1,this.starCount=0,this.entered=!1,this.on("enterframe",function(){!this.entered&&this.isInScreen()?this.entered=!0:this.entered&&!this.isInScreen()&&this.remove()})},damage:function(){this.hp-=1,this.hp<=0&&this.remove()},isInScreen:function(){return.5*-this.size<=this.x&&this.x<=W+.5*this.size&&.5*-this.size<=this.y&&this.y<=H+.5*this.size},update:function(){this.entered&&(this.runner.x=this.x,this.runner.y=this.y,this.runner.update())}}),Enemy.types={},Enemy.types.small=["SmallEnemy0","SmallEnemy1","SmallEnemy2"],Enemy.types.middle=["MiddleEnemy0","MiddleEnemy1"],Enemy.types.large=["LargeEnemy0","LargeEnemy1","LargeEnemy2"],tm.define("SmallEnemy0",{superClass:"Enemy",init:function(a){this.superInit(50,240),this.runner=Danmaku.small[a].createRunner(Danmaku.param),this.hp=ENEMY_SMALL_HP,this.starCount=1,this.tweener.by({y:H},1200,"easeOutQuad").wait(500).by({y:-H},1200,"easeInQuad")}}),tm.define("SmallEnemy1",{superClass:"Enemy",init:function(a){this.superInit(50,240),this.runner=Danmaku.small[a].createRunner(Danmaku.param),this.hp=ENEMY_SMALL_HP,this.starCount=1;var b=tm.geom.Vector2(0,4),c=Danmaku.param.target;this.on("enterframe",function(){if(this.y<c.y){var a=tm.geom.Vector2.sub(c.position,this.position).normalize().mul(.2);b.add(a).normalize().mul(4)}this.position.add(b)})}}),tm.define("SmallEnemy2",{superClass:"Enemy",init:function(a){this.superInit(50,240),this.runner=Danmaku.small[a].createRunner(Danmaku.param),this.hp=ENEMY_SMALL_HP,this.starCount=1;var b=tm.geom.Vector2(0,4),c=Danmaku.param.target;this.on("enterframe",function(){if(this.y<c.y){var a=tm.geom.Vector2.sub(c.position,this.position).normalize().mul(.2);b.add(a).normalize().mul(8)}this.position.add(b)})}}),tm.define("MiddleEnemy0",{superClass:"Enemy",init:function(a){this.superInit(100,120),this.runner=Danmaku.middle[a].createRunner(Danmaku.param),this.hp=ENEMY_MIDDLE_HP,this.erasing=!0,this.starCount=5,this.tweener.to({y:120},1200,"easeOutQuad"),this.on("enterframe",function(){this.y+=2})}}),tm.define("MiddleEnemy1",{superClass:"Enemy",init:function(a){this.superInit(100,120),this.runner=Danmaku.middle[a].createRunner(Danmaku.param),this.hp=ENEMY_MIDDLE_HP,this.erasing=!0,this.starCount=5,this.tweener.to({y:120},1200,"easeOutQuad"),this.on("enterframe",function(){this.y+=2})}}),tm.define("LargeEnemy0",{superClass:"Enemy",init:function(a){this.superInit(150,0),this.runner=Danmaku.large[a].createRunner(Danmaku.param),this.hp=ENEMY_LARGE_HP,this.erasing=!0,this.starCount=10,this.tweener.to({y:180},2400,"easeOutQuad"),this.on("enterframe",function(){this.y+=.25})}}),tm.define("LargeEnemy1",{superClass:"Enemy",init:function(a){this.superInit(150,0),this.runner=Danmaku.large[a].createRunner(Danmaku.param),this.hp=ENEMY_LARGE_HP,this.erasing=!0,this.starCount=10,this.one("enterframe",function(){this.tweener.by({x:W},2400,"easeOutQuad")}),this.on("enterframe",function(){this.y+=.05})}}),tm.define("LargeEnemy2",{superClass:"Enemy",init:function(a){this.superInit(150,0),this.runner=Danmaku.large[a].createRunner(Danmaku.param),this.hp=ENEMY_LARGE_HP,this.erasing=!0,this.starCount=10,this.one("enterframe",function(){this.tweener.by({x:-W},2400,"easeOutQuad")}),this.on("enterframe",function(){this.y+=.05})}}),tm.define("Bullet",{superClass:"tm.display.Sprite",init:function(a,b){this.superInit("bullet",64,64),this.baseFrameIndex=this.frameIndex=b,this.boundingType="circle",this.checkHierarchy=!1,this.radius=BULLET_BOUNDING_RADIUS,this.size=a,this.age=0,this.itemize=!1,this.erasing=!1,this.runner=null,this.pool=null,this.on("removed",function(){this.pool.push(this)})},update:function(){if(null!==this.runner){this.runner.update(),this.rotation=Math.atan2(this.runner.y-this.y,this.runner.x-this.x)*Math.RAD_TO_DEG,this.position.setObject(this.runner),this.age+=1;var a=this.age%8;a>4&&(a=8-a),this.frameIndex=this.baseFrameIndex+2+a,this.isInScreen()||this.remove()}},erase:function(a){!this.erasing&&this.visible?(this.itemize=a,this.blendMode="lighter",this.tweener.clear().to({scaleX:1.5,scaleY:1.5,alpha:0},120).call(function(){this.parent&&this.remove()}.bind(this)),this.erasing=!0):this.visible||this.remove()},isInScreen:function(){return.5*-this.size<=this.x&&this.x<=W+.5*this.size&&.5*-this.size<=this.y&&this.y<=H+.5*this.size}}),tm.define("BulletPool",{init:function(){this.redSmall=[],this.blueSmall=[],this.redLarge=[],this.blueLarge=[],this.redSmallCircle=[],this.blueSmallCircle=[],this.redLargeCircle=[],this.blueLargeCircle=[],this.invisible=[],BULLET_POOL_SIZE.times(function(){var a;a=Bullet(20,16),a.pool=this.redSmall,this.redSmall.push(a),a=Bullet(20,24),a.pool=this.blueSmall,this.blueSmall.push(a),a=Bullet(30,0),a.pool=this.redLarge,this.redLarge.push(a),a=Bullet(30,8),a.pool=this.blueLarge,this.blueLarge.push(a),a=Bullet(20,48),a.pool=this.redSmallCircle,this.redSmallCircle.push(a),a=Bullet(20,56),a.pool=this.blueSmallCircle,this.blueSmallCircle.push(a),a=Bullet(30,32),a.pool=this.redLargeCircle,this.redLargeCircle.push(a),a=Bullet(30,40),a.pool=this.blueLargeCircle,this.blueLargeCircle.push(a),a=Bullet(30,0),a.pool=this.invisible,a.visible=!1,this.invisible.push(a)}.bind(this)),this.pools=[this.redSmall,this.blueSmall,this.redLarge,this.blueLarge,this.redSmallCircle,this.blueSmallCircle,this.redLargeCircle,this.blueLargeCircle,this.invisible]},get:function(a,b){var c=this.pools[a].shift();return void 0!==c?(c.erasing=!1,c.runner=b,c.position.setObject(b),c.itemize=!1,c.age=0,c.setScale(1).setAlpha(1).setBlendMode("source-over"),c):(console.warn("弾が足りないニャ"),null)}}),tm.define("Player",{superClass:"tm.display.Shape",init:function(){this.superInit({width:80,height:80}),this.marker=null,this.blendMode="lighter",this.canvas.setLineStyle(3).setFillStyle("hsl(220, 30%, 30%)").setStrokeStyle("hsl(220, 90%, 90%)").fillTriangle(40,3,50,58,30,58).strokeTriangle(40,3,50,58,30,58).fillTriangle(30,25,25,58,5,68).strokeTriangle(30,25,25,58,5,68).fillTriangle(50,25,55,58,75,68).strokeTriangle(50,25,55,58,75,68),this.setPosition(.5*W,.8*H),this.roll=0,this.muteki=!1,this.positionHistory=[],this.shot=Shot(),this.bits=Array.range(4).map(function(a){return Bit(this,a)}.bind(this)),this.alive=!0},damage:function(){this.muteki||(this.muteki=!0,this.flare("missed"))},onadded:function(){this.bits.forEach(function(a){this.parent.addChildAt(a,0)}.bind(this)),this.positionHistory=Array.range((BIT_COUNT+1)*BIT_DISTANCE+BIT_FIRST_DISTANCE).map(function(){return{x:this.x,y:this.y}}.bind(this))},update:function(a){var b=this.x,c=this.y;this.alive&&!a.pointing.getPointingStart()&&a.pointing.getPointing()&&this.position.add(a.pointing.deltaPosition.mul(PLAYER_SPEED)),this.x=Math.clamp(this.x,6,W-6),this.y=Math.clamp(this.y,6,H-6),b<this.x?this.roll-=1:this.x<b?this.roll+=1:0!==this.roll&&(this.roll+=-Math.abs(this.roll)/this.roll),this.roll=Math.clamp(this.roll,-5,5),this.scaleX=1-.15*Math.abs(this.roll),this.marker.position.setObject(this),(this.x!==b||this.y!==c)&&(this.positionHistory.push({x:this.x,y:this.y}),this.positionHistory.length>(BIT_COUNT+1)*BIT_DISTANCE+BIT_FIRST_DISTANCE&&this.positionHistory.shift()),null==this.shot.parent&&this.shot.setPosition(this.x,this.y).addChildTo(this.parent),this.alpha=this.muteki?Math.floor(a.frame/2)%2*.75+.25:1}}),tm.define("Bit",{superClass:"tm.display.RectangleShape",init:function(a,b){this.superInit({width:30,height:30,strokeStyle:"hsl(100, 90%, 90%)",fillStyle:"hsl(100, 30%, 30%)"}),this.player=a,this.index=b,this.shot=Shot()},update:function(){this.rotation+=20;var a=this.player.positionHistory[6*(1+this.index)];void 0===a&&(a={x:this.player.x,y:this.player.y}),this.position.setObject(a),null==this.shot.parent&&this.shot.setPosition(this.x,this.y).addChildTo(this.parent)}}),tm.define("PlayerCollisionCircle",{superClass:"tm.display.CircleShape",init:function(){this.superInit({width:18,height:18,strokeStyle:"hsl(150, 90%, 90%)",fillStyle:"hsl(150, 30%, 30%)",lineWidth:4})},update:function(a){this.setScale(1+.2*Math.sin(.4*a.frame))}}),tm.define("Shot",{superClass:"tm.display.RectangleShape",init:function(){this.superInit({width:10,height:30,strokeStyle:"hsl(220, 90%, 90%)",fillStyle:"hsl(220, 30%, 30%)"}),this.blendMode="lighter",this.checkHierarchy=!1},update:function(){this.y-=SHOT_SPEED,this.y<-20&&this.remove()}});var Explosion=function(a,b,c){6..times(function(){var d=Math.rand(0,360),e=Math.randf(.8,1.5);8..times(function(f){var g=tm.geom.Vector2().setAngle(d,(1+3*f)*e),h=Explosion.pool.shift();h&&h.emit(b,c,g).setScale(2-.2*f).addChildTo(a)})})};Explosion.Particle=tm.createClass({superClass:tm.display.RectangleShape,init:function(){this.superInit({width:40,height:40,strokeStyle:"hsl(30, 65%, 60%)",fillStyle:"hsl(30, 65%, 30%)"}),this.setBlendMode("lighter"),this.v=null},emit:function(a,b,c){return this.setPosition(a,b),this.setAlpha(.4),this.v=c,this},update:function(){this.position.add(this.v),this.v.mul(.9),this.alpha*=.9,this.alpha<.001&&(this.remove(),Explosion.pool.push(this))}}),Explosion.pool=Array.range(256).map(function(){return Explosion.Particle()});var PlayerExplosion=function(a,b,c){var d=["sound/exp1","sound/exp2","sound/exp3"].pickup();tm.sound.SoundManager.play(d),6..times(function(){var d=Math.rand(0,360),e=Math.randf(.8,1.5);8..times(function(f){var g=tm.geom.Vector2().setAngle(d,(1+4*f)*e),h=PlayerExplosion.pool.shift();h&&h.emit(b,c,g).setScale(2-.2*f).addChildTo(a)})})};PlayerExplosion.Particle=tm.createClass({superClass:tm.display.RectangleShape,init:function(){this.superInit({width:60,height:60,strokeStyle:"hsl(230, 65%, 60%)",fillStyle:"hsl(230, 65%, 30%)"}),this.setBlendMode("lighter"),this.v=null},emit:function(a,b,c){return this.setPosition(a,b),this.setAlpha(.4),this.v=c,this},update:function(){this.position.add(this.v),this.v.mul(.95),this.alpha*=.95,this.alpha<.001&&(this.remove(),PlayerExplosion.pool.push(this))}}),PlayerExplosion.pool=Array.range(256).map(function(){return PlayerExplosion.Particle()}),tm.define("StarItem",{superClass:"tm.display.StarShape",init:function(a){this.superInit({width:30,height:30}),this.pool=a,this.target=null,this.flying=!1,this.boundingType="circle",this.radius=30,this.checkHierarchy=!1,this.fv=tm.geom.Vector2(0,0)},onremoved:function(){this.pool.stars.push(this)},update:function(){if(this.flying)this.position.add(this.fv),this.fv.mul(.7),this.fv.lengthSquared()<.1*.1&&(this.flying=!1);else if(this.target){var a=tm.geom.Vector2.sub(this.target,this);a.normalize().mul(10),this.position.add(a)}else this.y+=3;H+30<this.y&&this.remove()},setTarget:function(a){this.target=a}}),tm.define("StarItemPool",{init:function(){this.stars=Array.range(1024).map(function(){return StarItem(this)}.bind(this))},get:function(){var a=this.stars.shift();return void 0!==a?(a.target=null,a):null}}),tm.define("TitleScene",{superClass:"tm.app.Scene",init:function(){this.superInit(),this.fromJSON({children:{backgroundLayer:{type:"CanvasLayer",init:"#back",renderInterval:6},bg:{type:"tm.display.RectangleShape",init:{width:SCREEN_WIDTH,height:SCREEN_HEIGHT,strokeStyle:"transparent",fillStyle:"white"},originX:0,originY:0},title:{type:"tm.display.Label",init:["よけろ！弾幕さん",40],fillStyle:"black",x:.5*SCREEN_WIDTH,y:SCREEN_HEIGHT*(1/(1+1.618)),interactive:!0,onpointingend:function(a){a.app.popScene()}},hmdLayer:{type:"CanvasLayer",init:"#hmd",renderInterval:6}}})}}),tm.define("GameScene",{superClass:"tm.app.Scene",init:function(){var a=this;this.superInit(),this.fromJSON({children:{backgroundLayer:{type:"CanvasLayer",init:"#back",renderInterval:4,children:{background:{type:"Background"}}},enemyLayer:{type:"GameSceneLayer",counter:0,update:function(){this.counter+=a.weight,this.counter>=1?(this.counter-=1,this.children.forEach(function(a){a.wakeUp()})):this.children.forEach(function(a){a.sleep()})}},playerLayer:{type:"GameSceneLayer",children:{player:{type:"Player"}}},bulletLayer:{type:"GameSceneLayer",counter:0,update:function(){this.counter+=a.weight,this.counter>=1?(this.counter-=1,this.children.forEach(function(a){a.wakeUp()})):this.children.forEach(function(a){a.sleep()})}},topLayer:{type:"GameSceneLayer",children:{playerMarker:{type:"PlayerCollisionCircle"}}},hmdLayer:{type:"CanvasLayer",init:"#hmd",renderInterval:3,children:{scoreLabel:{type:"tm.display.Label",init:["0 点",30],align:"right",baseline:"top",x:SCREEN_WIDTH-20,y:20,displayScore:0,bs:0,unit:0,update:function(){this.bs!==a.score&&(this.unit=Math.floor((a.score-this.displayScore)/9)),this.unit<a.score-this.displayScore?this.displayScore+=this.unit:this.displayScore<a.score&&(this.displayScore=a.score),this.text=this.displayScore+" 点",this.bs=a.score}},stepLabel:{type:"tm.display.Label",init:["ステップ 0",30],align:"right",baseline:"top",x:SCREEN_WIDTH-20,y:60,update:function(){this.text="ステップ "+a.step}},debugLabel:{type:"tm.display.Label",init:["",30],align:"right",baseline:"top",x:SCREEN_WIDTH-20,y:100,update:function(){this.text="enemyInterval "+a.enemyInterval}},zankiLabel:{type:"tm.display.Label",init:["残機 2",30],align:"left",baseline:"top",x:20,y:20,update:function(){this.text="残機 "+Math.max(a.zanki-1,0)}}}}}}),this.score=0,this.zanki=3,this.weight=1,this.bulletPool=BulletPool(),this.starPool=StarItemPool(),this.player=this.playerLayer.player,this.player.marker=this.topLayer.playerMarker,this.player.on("missed",function(){tm.sound.SoundManager.play("sound/miss"),PlayerExplosion(a.backgroundLayer.background.fg,this.x,this.y),a.zanki-=1,a.zanki>0?this.tweener.clear().wait(3e3).call(function(){this.muteki=!1}.bind(this)):(this.muteki=!1,this.alive=!1,a.playerLayer.hide(),a.topLayer.playerMarker.hide(),a.tweener.wait(3e3).call(function(){a.nextLabel="title",a.app.popScene()}))}),Danmaku.param={target:this.player,createNewBullet:function(b,c){var d=a.bulletPool.get(c.type,b);null!=d&&(a.bullets.push(d),d.onremoved=function(){if(a.bullets.erase(this),this.itemize){var b=a.starPool.get();null!==b&&(b.setPosition(this.x,this.y).addChildTo(a.backgroundLayer.background.fg),b.flying=!1,a.stars.push(b))}},d.addChildTo(a.bulletLayer))}},this.mt=new MersenneTwister(MT_SEED),this.mt.range=function(a,b){return a+this.nextInt(b-a)},this.mt.rangef=function(a,b){return a+this.next()*(b-a)},this.mt.pickup=function(a){return a[this.nextInt(a.length)]},this.countDown=200,this.enemyInterval=200,this.step=0,this.enemies=[],this.shots=[this.player.shot,this.player.bits[0].shot,this.player.bits[1].shot,this.player.bits[2].shot,this.player.bits[3].shot],this.bullets=[],this.stars=[],this.on("exit",function(){tm.sound.SoundManager.stopMusic()})},eraseAllBullets:function(a){this.bullets.forEach(function(b){b.erase(a)})},update:function(){if(this.player.alive&&this.testHit(),this.countDown-=1,this.countDown<=0){this.enemyInterval=Math.max(this.enemyInterval-1,40),this.step+=1,this.step%20===0&&(this.enemyInterval+=10);var a=50;50>a?(this._launchSmall(),this.countDown=1*this.enemyInterval):80>a?(this._launchMiddle(),this.countDown=1.4*this.enemyInterval):(this._launchLarge(),this.countDown=1.8*this.enemyInterval)}this.weight=Math.max(1-this.bullets.length/800,.1),this.player.muteki&&this.eraseAllBullets(!1)},addScore:function(a){Math.floor(this.score/EXTEND_SCORE)<Math.floor((this.score+a)/EXTEND_SCORE)&&(this.zanki+=1,tm.sound.SoundManager.play("sound/extend")),this.score+=a},testHit:function(){this.testPlayerVsStarItem(),this.testShotVsEnemy(),this.testPlayerVsBullet()},testPlayerVsStarItem:function(){for(var a,b=this.player,c=this.stars.slice(),d=0,e=c.length;e>d;d++)a=c[d],a.isHitPoint(b.x,b.y)?(a.parent&&a.remove(),this.stars.erase(a),this.score+=100,tm.sound.SoundManager.play("sound/score")):(b.x-a.x)*(b.x-a.x)+(b.y-a.y)*(b.y-a.y)<4e4&&a.setTarget(b)},testShotVsEnemy:function(){for(var a,b,c=this.shots.slice(),d=this.enemies.slice(),e=0,f=d.length;f>e;e++){b=d[e];for(var g=0,h=c.length;h>g;g++)if(a=c[g],null!=a.parent&&b.isHitPoint(a.x,a.y)&&(b.damage(),a.remove(),tm.sound.SoundManager.play("sound/hit"),null==b.parent)){Explosion(this.backgroundLayer.background.fg,b.x,b.y);var i=["sound/exp1","sound/exp2","sound/exp3"].pickup();tm.sound.SoundManager.play(i),b.erasing&&this.eraseAllBullets(!0);for(var j=0;j<b.starCount;j++){var k=this.starPool.get();null!==k&&(k.setPosition(b.x,b.y).addChildTo(this.backgroundLayer.background.fg),k.flying=!0,k.fv=tm.geom.Vector2().setRandom(-135,-45,50),this.stars.push(k))}break}}},testPlayerVsEnemy:function(){for(var a,b=this.player,c=0,d=this.enemies.length;d>c;c++)a=this.enemies[c],a.isHitPoint(b.x,b.y)&&(b.damage(),this.eraseAllBullets(!1))},testPlayerVsBullet:function(){for(var a,b=this.player,c=this.bullets.slice(),d=0,e=c.length;e>d;d++)a=c[d],a.visible&&!a.erasing&&a.isHitPoint(b.x,b.y)&&(b.damage(),a.remove(),this.eraseAllBullets(!1))},_launchSmall:function(){var a=this,b=this.mt.nextInt(Danmaku.small.length),c=5*(1+this.mt.nextInt(3)),d=this.mt.pickup(Enemy.types.small);c.times(function(){var c=tm.using(d)(b).setPosition(this.mt.range(60,W-60),-H*this.mt.rangef(.4,.8));c.onadded=function(){a.enemies.push(this)},c.onremoved=function(){a.enemies.erase(this)},EnemySpawner(c,this.mt.range(1,1e3)).addChildTo(this.enemyLayer)}.bind(this))},_launchMiddle:function(){var a=this,b=this.mt.nextInt(Danmaku.middle.length),c=2+this.mt.nextInt(2),d=this.mt.pickup(Enemy.types.middle);c.times(function(){var c=tm.using(d)(b).setPosition(this.mt.range(120,W-120),-H*this.mt.rangef(.5,.8));c.onadded=function(){a.enemies.push(this)},c.onremoved=function(){a.enemies.erase(this)},EnemySpawner(c,this.mt.range(1,1e3)).addChildTo(this.enemyLayer)}.bind(this))},_launchLarge:function(){var a=this,b=this.mt.nextInt(Danmaku.large.length),c=this.mt.pickup(Enemy.types.large),d=tm.using(c)(b);"LargeEnemy0"===c?d.setPosition(this.mt.range(180,W-180),-H*Math.randf(.5,.8)):"LargeEnemy1"===c?d.setPosition(-this.mt.range(.2*W,.8*W),180):d.setPosition(W+this.mt.range(.2*W,.8*W),180),d.onadded=function(){a.enemies.push(this)},d.onremoved=function(){a.enemies.erase(this)},d.addChildTo(this.enemyLayer)},onpoped:function(){this.backgroundLayer.clear().setVisible(!1),this.hmdLayer.clear().setVisible(!1)}}),tm.define("EnemySpawner",{superClass:"tm.display.CanvasElement",init:function(a,b){this.superInit(),this.enemy=a,this.tweener.wait(b).call(function(){this.spawn()}.bind(this))},spawn:function(){this.parent.addChild(this.enemy),this.remove()}}),tm.define("GameSceneLayer",{superClass:"tm.display.CanvasElement",init:function(){this.superInit(),this.fromJSON({originX:0,originY:0,width:W,height:H,clipping:!0})}}),tm.main(function(){var a=Application();a.run();var b=tm.game.LoadingScene({width:SCREEN_WIDTH,height:SCREEN_HEIGHT,assets:ASSETS,nextScene:ManagerScene});a.replaceScene(b)}),tm.define("ManagerScene",{superClass:"tm.game.ManagerScene",init:function(){tm.dom.Element("#back").visible=!0,tm.dom.Element("#hmd").visible=!0,this.superInit({startLabel:"title",scenes:[{label:"title",className:"TitleScene"},{label:"game",className:"GameScene"}]})}});